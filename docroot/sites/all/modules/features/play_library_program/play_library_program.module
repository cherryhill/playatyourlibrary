<?php
/**
 * @file
 * Code for the PLAY Library Program feature.
 */

include_once 'play_library_program.features.inc';

/**
 * function get field_language($entity_type, $entity, $field_name = NULL, $langcode = NULL);
 */
  
function get_entity_field_language($entity_type, $entity) {
  $field_language = field_language($entity_type, $entity);
  return $field_language;
}
/**
 * Implements hook_menu().
 */
function play_library_program_menu() {

  $items = array();

  $items['play-library-program/add/activity/%/%'] = array(
    'title' => 'Complete Activity',
    'page callback' => 'play_library_program_complete_activity',
    'page arguments' => array(3, 4),
    'access callback' => 'play_library_program_access_activity_entry',
    'access arguments' => array(3),
    'type' => MENU_CALLBACK,
  );

  $items['play-library-program/add/raffle_winner/%/%'] = array(
    'title' => 'Complete Activity',
    'page callback' => 'play_library_program_create_raffle_winner',
    'page arguments' => array(3, 4),
    'access callback' => 'user_access',
    'access arguments' => array('eck add raffle raffle_winner entities'),
    'type' => MENU_CALLBACK,
  );

  $items['testing-purposes'] = array(
    'title' => 'Reviews',
    'page callback' => 'pl_check_reward_validation',
    'access arguments' => array('access content'),
    'type' => MENU_SUGGESTED_ITEM,
  );

  return $items;
}

/**
 * Implements hook_form_alter()
 */
function play_library_program_form_alter(&$form, &$form_state, $form_id){
  if($form_id == 'eck__entity__form_edit_activity_activity' || $form_id == 'eck__entity__form_add_activity_activity'){
    $form['title']['#title'] = t('Name of Activity');
  }
}

/**
 * Access control to access activity entry creation.
 */
function play_library_program_access_activity_entry($activity_id) {
  
  global $language;
  //$lang = $language->language;

  global $user;
  $activities = entity_load('activity', array($activity_id));
  $activity = reset($activities);
  //get language codes for activity fields
  $lang = field_language('activity',$activity);
  foreach ($lang as $key => $value) {
  	${$key} = $value;
  }
   
  $points = intval($activity->field_activity_points[$field_activity_points][0]['value']);
  $daily_limit = FALSE;
  $current_participation_count = play_library_program_retrieve_activity_participation($activity_id, $user->uid);

  if ($current_participation_count > 0) {
    $last_entry = db_query("SELECT created FROM {eck_activity} WHERE uid = :uid ORDER BY created DESC LIMIT 1", array(':uid' => $user->uid))->fetchField();
    if ((time() - $activity->field_activity_time_limit[$field_activity_time_limit][0]['value']) < $last_entry) {
      return FALSE;
    }
  }

  if ($points > 0 && $current_participation_count <= $activity->field_activity_limit[$field_activity_limit][0]['value']) {
    return user_access('eck add activity activity_entry entities') || user_access('eck add activity entities') || user_access('eck add entities');
  }

  return FALSE;
}

/**
 *  Condition for activity frequecy limit;
 */
function play_library_program_frequency_limit($activity, $activity_time, $account_id) {

	global $language;
	// global $event_time;
	//get language code
	$lang = field_language('activity',$activity);
	foreach ($lang as $key => $value) {
		${$key} = $value;
	}

	$activity_id = $activity->id;
	$activity_title = $activity->title;
	$activity_requency_limit = $activity->field_activity_time_limit[$field_activity_time_limit][0]['value'];
	$start_time =$activity_time - $activity_requency_limit+1;
	$end_time = $activity_time + $activity_requency_limit-1;

	$arr = array($start_time,$end_time);

	$query = new EntityFieldQuery();
	$query->entityCondition('entity_type', 'activity');
	$query->entityCondition('bundle', 'activity_entry');
	$query->propertyCondition('uid', $account_id);
	$query->propertyCondition('created',$arr, 'BETWEEN');
	$query->fieldCondition('field_activity_entry_activity', 'target_id', $activity_id);
	$res = $query->count()->execute();

	if($res == 0) {    
	return TRUE;
	} else {
		drupal_set_message(t('You have already recorded '.$activity_title. ' for '.date('d-M-Y', $activity_time).'.'),'warning');
	return FALSE;
	}
}

/**
 * Condition for activity start date and end date;
 */
function play_library_program_activity_time_limit($activity, $activity_date) {
	global $language;
	//get language code
	$lang = field_language('activity',$activity);
	foreach ($lang as $key => $value) {
		${$key} = $value;
	}
	$activity_title = $activity->title;
	$activity_start_date = strtotime($activity->field_activity_start_date[$field_activity_start_date][0]['value']);
	$activity_end_date = strtotime($activity->field_activity_end_date[$field_activity_end_date][0]['value']);

	if($activity_start_date <= $activity_date && $activity_date <=  $activity_end_date) {
		return TRUE;
	} else {
		drupal_set_message(t('You cannot record this activity for the date <b>'. date('d-M-Y',$activity_date ). '</b> as participation for <b>'.$activity_title. '</b> is closed for this date'),'warning');
		return FALSE;
	}
} 
 
/**
 * Implements hook_block_info().
 */
function play_library_program_block_info() {

  $blocks = array();

  $blocks['activities'] = array(
    'info' => t('PLAY Program activities'),
    'cache' => DRUPAL_NO_CACHE
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function play_library_program_block_view($delta = '') {

  $block = array();

  if ($delta == 'activities') {
    $pending_activities = array();
    $completed_activities = array();
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'activity');
    $query->entityCondition('bundle', 'activity');
    $query->fieldCondition('field_activity_fired_hook', 'value', 'via_block');
    $result = $query->execute();

    foreach ($result as $entity_key => $entity_values) {
      if ($entity_key == 'activity') {
        foreach ($entity_values as $entity) {
          $activities = entity_load('activity', array($entity->id));
          $activity = reset($activities);
          if (play_library_program_access_activity_entry($entity->id)) {
            $pending_activities[] = l($activity->title, "play-library-program/add/activity/{$activity->id}/nojs");
          }
          else {
            $completed_activities[] = check_plain($activity->title);
          }
        }
      }
    }

    $block['subject'] = t('What did you do today?');
    $block['content'] = theme('play_library_program_activities_block', array('pending' => $pending_activities, 'completed' => $completed_activities));
    }

  return $block;
}

/**
 * Implements hook_field_widget_form_alter().
 */
function play_library_program_field_widget_form_alter(&$element, &$form_state, $context) {

  if (isset($element['value']['#field_name']) && $element['value']['#field_name'] == 'field_activity_fired_hook') {
    $options = array(
      'via_block' => t('- Select Firing Hook -'),
      'user_insert' => t(variable_get('user_insert')) ? t(variable_get('user_insert')) : t('User is Inserted'),
      'progress_page' => t('Record through progress report'),
    );

    // For now, only deal with nodes and other ECK content models.
    $entities = entity_get_info();

    foreach($entities as $entity_key => $entity) {
      if ($entity_key == 'node') {
        $entity['module'] = 'node';
      }

      if (isset($entity['module']) && ($entity['module'] == 'eck' || $entity['module'] == 'node')) {
        foreach ($entity['bundles'] as $bundle_key => $bundle_options) {
          if($entity_key == 'node' && $bundle_options['label'] == 'sticker') {
            $options["node_update|node|{$bundle_key}|updated"] = t("@value", array('@value' => variable_get($bundle_key))) ? t("@value", array('@value' => variable_get($bundle_key))) : t('Calender ');
          }

          if ($entity_key == 'node' && ($bundle_options['label'] == 'Booklist' || $bundle_options['label'] == 'Book Review' || $bundle_options['label'] == 'Movie Review' || $bundle_options['label'] == 'Video Game Review' || $bundle_options['label'] == 'Music Review' || $bundle_options['label'] == 'Activity Review')) {
            $options["node_update|node|{$bundle_key}|published"] = t("@value", array( '@value' => variable_get($bundle_key))) ? t("@value", array( '@value' => variable_get($bundle_key))) : t("@value", array( '@value' => $bundle_options['label']));
          }
        }
      }
    }

    if (module_exists('poll')) {
      $options["Poll answer submitted"] = t("@value", array( '@value' => variable_get('poll')));
    }

    if (module_exists('webform')) {
      $webforms = _play_library_program_get_webforms();
      foreach ($webforms as $webform) {
        $options["webform_submit|{$webform->nid}"] = t("@value", array( '@value' => variable_get($webform->nid))) ? t("@value", array( '@value' => variable_get($webform->nid))) : t("@value", array( '@value' => $webform->title));
      }
    }

    $element['value']['#type'] = 'select';
    $element['value']['#options'] = $options;
    $element['value']['#size'] = 0;
  }
}

/**
 * Implements hook_user_insert(). change
 */
function play_library_program_user_insert(&$edit, $account, $category) {
  $_SESSION['program_user_role_id']= $account->roles;

  global $language;
  $lang = $language->language;

  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'activity');
  $query->entityCondition('bundle', 'activity');
  $query->fieldCondition('field_activity_fired_hook', 'value', 'user_insert');
  $result = $query->execute();
  
  // set user age in session to use in reward validation
  $_SESSION['user_birth_dt'] = strtotime($edit['profile_main']['field_user_birthday'][$lang][0]['value']);
  foreach ($result as $entity_key => $entity_values) {
    if ($entity_key == 'activity') {
      foreach ($entity_values as $entity) {
        play_library_program_create_activity_entry($entity->id, $account->uid);
      }
    }
  }
}

function play_library_program_node_presave($node) {
  
  if(function_exists('play_library_program_pl_is_program_active')){
    if(!pl_is_program_active()) {
      drupal_goto('home');
      return FALSE;
    }
  }
}

function play_library_program_webform_submission_presave($node, &$submission) {

  if(function_exists('play_library_program_pl_is_program_active')){
    if(!pl_is_program_active()) {
      drupal_goto('home');
      return FALSE;
    }
  }
}


/**
 * Implements hook_entity_insert().
 */
function play_library_program_entity_insert($entity, $type) { 

  if(function_exists('play_library_program_pl_is_program_active')){
    if(!pl_is_program_active()) {      
      return FALSE;
    } 
  }
   
  // Could be node, could be eck, could be something else, but easy to check.
  if (!isset($entity->type)) {
    return;
  }

  // Also hardcoding that we do not create *new* activity entries for an activity entry.
  if ($entity->type !== 'activity_entry') {
    _play_library_program_invoke_activity_entry_hooks($entity, $type);
  }

  if ($entity->type == 'reward') {
    pl_add_taxonomy_term('R_'.$entity->id, 'userpoints',1);
  }

  if ($entity->type == 'activity') {
    pl_add_taxonomy_term('A_'.$entity->id,'userpoints',1);
  }

  if ($entity->type == 'activity_entry') {
    global $activityEntry_id;
    $activityEntry_id = $entity->id;
    _play_library_program_process_activity_entry($entity, $type);
  }

  if ($entity->type == 'reward_claim') {
    // _play_library_program_process_user_reward_claim($entity, $type);
  }
}


/**
 * Adding taxonomy term to a vocabulary
 */
function pl_add_taxonomy_term($name, $type, $display = 0 ){

  $term = new stdClass();
  $term_load = taxonomy_vocabulary_machine_name_load($type);
  if($term_load){
    $vid = $term_load->vid;
    $term->name = $name;
    $term->vid = $vid;
    taxonomy_term_save($term);
    if ($display){
      drupal_set_message(t($term->name. ' term saved for '. $type. 'vocabulory'), 'status');
      return TRUE;
    }
  } else {
    if ($display){
      drupal_set_message(t($term->name. ' term could nnot be added for '. $type . 'vocabulory'), 'error');
      return FALSE;
    }
  }
}

// /**
//  * Adding taxonomy term on adding of Activity wntity
//  */
// function pl_adding_taxonomy_term_for_activity($entity, $type){

//   $a_id = $entity->id;

//   $term = new stdClass();
//   $term_load = taxonomy_vocabulary_machine_name_load('userpoints');
//   $vid = $term_load->vid;
//   $term->name = 'A_'.$a_id;
//   $term->vid = $vid;
//   taxonomy_term_save($term);

//   drupal_set_message(t('New term term '. $term->name .' added for userpoints'));
// }

/**
 * List of reward ids associated with particular activity
 */
function pl_get_activity_reward_ids($activity_ids, $account_uid = NULL){
	//Get current user if account uid is not available
	global $user;
	if(empty($account_uid)){
		$account = $user;
	} else {
		$account = user_load($account_uid);
	}

	//change activity_id to array if its not
	if (!is_array($activity_ids)){
		$activity_ids = array($activity_ids);
	}
	//Get reward ids based on activity
	$query = new EntityFieldQuery();
	$query->entityCondition('entity_type','reward');
	$query->entityCondition('bundle','reward');
	$query->fieldCondition('field_activities_reward', 'target_id', $activity_ids, 'IN');
	$result = $query->execute();

	//get all reward ids in an array
	foreach($result['reward'] as $reward){
		$rids[] = $reward->id;
	}
	if(sizeof($rids)==0){
		return FALSE;
	}else{
		return $rids;
	}
}

/**
 * count of reward claimed by user
 */
function pl_receieved_rewards($account_uid, $reward_id){
  //Get reward type
  $sub_query= db_select('field_data_field_category','fdfc');
  $sub_query-> fields('fdfc', array('field_category_value'));
  $sub_query-> condition('fdfc.entity_id', $reward_id);
  $reward_type = $sub_query->execute()->fetchAll();
  
  //Get count of raffle entries or reward claims
  $que = db_select('eck_reward', 'eck_r');
  //Switch to get count from raffle/reward fields
  switch ($reward_type[0]->field_category_value) {
    case 'raffle_reward':
      $que->leftjoin('field_data_field_raffle_claim_id', 'fdfrfci', 'eck_r.id = fdfrfci.entity_id');
      $que->condition('fdfrfci.field_raffle_claim_id_target_id', array($reward_id), 'IN');
      break;
    case 'reward':
      $que->leftjoin('field_data_field_reward_claim_id', 'fdfrwci', 'eck_r.id = fdfrwci.entity_id');  
      $que->condition('fdfrwci.field_reward_claim_id_target_id',  array($reward_id), 'IN');
      break;
    default:
      $que->leftjoin('field_data_field_reward_claim_id', 'fdfrwci', 'eck_r.id = fdfrwci.entity_id');
      $que->condition('fdfrwci.field_reward_claim_id_target_id',  array($reward_id), 'IN');
      break;
  }
  $que->condition('eck_r.uid', $account_uid);
  $que->fields('eck_r', array('id'));
  $res = $que->execute()->rowCount();
  return $res;
}

function pl_reward_claim($reward_id, $account_uid, $category, $filters = NULL, $rf_drawing = NULL, $raffle_clm = NULL, $draw_time= NULL){

	global $activityEntry_id;

	if (empty($account_uid)) {
		global $user;
		$account_uid = $user->uid;
	}
	
	if (isset($activityEntry_id)) {
		$activityUpdates = entity_load('activity', array($activityEntry_id));
		$activityUpdate = reset($activityUpdates);
		//Get languauge code for activities
		$lang = field_language('activity',$activityUpdate);
		foreach ($lang as $key => $value) {
			${$key} = $value;
		}

		$activityUpdate->field_rw_claim_id[$field_rw_claim_id][0]['value'] = $reward_id;
		$activityUpdate->field_progress_info[$field_progress_info][0]['value'] = t('Congratulations! You have earned a prize!');
		field_attach_update('activity', $activityUpdate);
		unset($activityEntry_id);
	}

	$rewards = entity_load('reward', array($reward_id));
	$reward = reset($rewards);
	//Get language code forreward fields
	$lang = field_language('reward',$reward);
	foreach ($lang as $key => $value) {
		${$key} = $value;
	}

	$onscreenMsgId = $reward->field_raffle_reward_noti[$field_raffle_reward_noti][0]['value'];
	$onsRaffleMsgId = $reward->field_raffle_notification[$field_raffle_notification][0]['value'];
	$reward_mess_sub = $reward->field_raffle_reward_noti[$field_raffle_reward_noti][0]['value'];
	$reward_message_body = $reward->field_raffle_reward_noti[$field_raffle_reward_noti][0]['value'];
	$raffle_mess_sub = $reward->field_raffle_notification[$field_raffle_notification][0]['value'];
	$raffle_message_body = $reward->field_raffle_notification[$field_raffle_notification][0]['value']; 
	// Onscreen message for the reward claim.
	$rewardOnscMsg = messages_for_reward_claim($onscreenMsgId);
	// Onscreen message for the raffle claim.
	$raffleOnsMsg = messages_for_raffle_entry($onsRaffleMsgId);
	$raffle_pm_sub = pm_raffle_messages_sub_for_reward_claim($raffle_mess_sub);
	$raffle_pm_body = pm_raffle_messages_body_for_reward_claim($raffle_message_body);
	$reward_pm_sub = pm_reward_messages_sub_for_reward_claim($reward_mess_sub);
	$reward_pm_body = pm_reward_messages_body_for_reward_claim($reward_message_body); 


	//Entity insert in reward/raffle.
	if ($category == 'reward') {
		$title = t("@reward on @time", array('@reward' => $reward->title, '@time' => date('Y-m-d H:i')));
		$reward_claim = entity_create('reward', array('type' => 'reward_claim', 'title' => $title, 'uid' => $account_uid));
		$lang = field_language('reward',$reward_claim);
		foreach ($lang as $key => $value) {
			${$key} = $value;
		}
		$reward_claim->field_reward_claim_id[$field_reward_claim_id][0]['target_id'] = $reward_id;
		$reward_claim->field_filters_used[$field_filters_used][0]['value'] = $filters;
		$reward_claim->field_rf_drawing_name[$field_rf_drawing_name][0]['value'] = $rf_drawing;
		$reward_claim->field_raffle_claim[$field_raffle_claim][0]['value'] = $raffle_clm;
		$reward_claim->field_raff_draw_timestamp[$field_raff_draw_timestamp][0]['value'] = $draw_time;
		entity_save('reward', $reward_claim);
		drupal_set_message(t($rewardOnscMsg), 'status');
		_play_library_program_send_pm_message($account_uid, $reward_pm_sub, $reward_pm_body);
	} else if ($category == 'raffle_reward') {
		$title = t("@reward on @time", array('@reward' => $reward->title, '@time' => date('Y-m-d H:i')));
		$raffle_entry = entity_create('reward', array('type' => 'raffle_claim', 'title' => $title, 'uid' => $account_uid));
    $lang = field_language('reward',$raffle_entry);
    foreach ($lang as $key => $value) {
      ${$key} = $value;
    }

		$raffle_entry->field_raffle_claim_id[$field_raffle_claim_id][0]['target_id'] = $reward_id;
      // echo '<pre>'; print_r($raffle_entry); die();
    
		entity_save('reward', $raffle_entry);
		drupal_set_message(t($raffleOnsMsg),'status');
		_play_library_program_send_pm_message($account_uid, $raffle_pm_sub, $raffle_pm_body);
	}
}


//Function bulk reward claim
function pl_bulkreward_claim($reward_id, $account_uid, $category, $filters = NULL, $rf_drawing = NULL, $raffle_clm = NULL, $draw_time= NULL){

	global $activityEntry_id;

	if (empty($account_uid)) {
		global $user;
		$account_uid = $user->uid;
	}
	
	if (isset($activityEntry_id)) {
		$activityUpdates = entity_load('activity', array($activityEntry_id));
		$activityUpdate = reset($activityUpdates);
		//Get languauge code for activities
		$lang = field_language('activity',$activityUpdate);
		foreach ($lang as $key => $value) {
			${$key} = $value;
		}

		$activityUpdate->field_rw_claim_id[$field_rw_claim_id][0]['value'] = $reward_id;
		$activityUpdate->field_progress_info[$field_progress_info][0]['value'] = t('Congratulations! You have earned a prize!');
		field_attach_update('activity', $activityUpdate);
		unset($activityEntry_id);
	}

	$rewards = entity_load('reward', array($reward_id));
	$reward = reset($rewards);
	//Get language code forreward fields
	$lang = field_language('reward',$reward);
	foreach ($lang as $key => $value) {
		${$key} = $value;
	}

	$onscreenMsgId = $reward->field_raffle_reward_noti[$field_raffle_reward_noti][0]['value'];
	$onsRaffleMsgId = $reward->field_raffle_notification[$field_raffle_notification][0]['value'];
	$reward_mess_sub = $reward->field_raffle_reward_noti[$field_raffle_reward_noti][0]['value'];
	$reward_message_body = $reward->field_raffle_reward_noti[$field_raffle_reward_noti][0]['value'];
	$raffle_mess_sub = $reward->field_raffle_notification[$field_raffle_notification][0]['value'];
	$raffle_message_body = $reward->field_raffle_notification[$field_raffle_notification][0]['value']; 
	// Onscreen message for the reward claim.
	$rewardOnscMsg = messages_for_reward_claim($onscreenMsgId);
	// Onscreen message for the raffle claim.
	$raffleOnsMsg = messages_for_raffle_entry($onsRaffleMsgId);
	$raffle_pm_sub = pm_raffle_messages_sub_for_reward_claim($raffle_mess_sub);
	$raffle_pm_body = pm_raffle_messages_body_for_reward_claim($raffle_message_body);
	$reward_pm_sub = pm_reward_messages_sub_for_reward_claim($reward_mess_sub);
	$reward_pm_body = pm_reward_messages_body_for_reward_claim($reward_message_body); 


	//Entity insert in reward/raffle.
	if ($category == 'reward') {
		$title = t("@reward on @time", array('@reward' => $reward->title, '@time' => date('Y-m-d H:i')));
		$reward_claim = entity_create('reward', array('type' => 'reward_claim', 'title' => $title, 'uid' => $account_uid));
		$lang = field_language('reward',$reward_claim);
		foreach ($lang as $key => $value) {
			${$key} = $value;
		}
		$reward_claim->field_reward_claim_id[$field_reward_claim_id][0]['target_id'] = $reward_id;
		$reward_claim->field_filters_used[$field_filters_used][0]['value'] = $filters;
		$reward_claim->field_rf_drawing_name[$field_rf_drawing_name][0]['value'] = $rf_drawing;
		$reward_claim->field_raffle_claim[$field_raffle_claim][0]['value'] = $raffle_clm;
		$reward_claim->field_raffle_draw_timestamp[$field_raffle_draw_timestamp][0]['value'] = $draw_time;
		entity_save('reward', $reward_claim);
		drupal_set_message(t($rewardOnscMsg), 'status');
		_play_library_program_send_pm_message($account_uid, $reward_pm_sub, $reward_pm_body);
	} else if ($category == 'raffle_reward') {
		$title = t("@reward on @time", array('@reward' => $reward->title, '@time' => date('Y-m-d H:i')));
		$raffle_entry = entity_create('reward', array('type' => 'raffle_claim', 'title' => $title, 'uid' => $account_uid));
		$lang = field_language('reward',$raffle_entry);
		$raffle_entry->field_raffle_claim_id[$field_raffle_claim_id][0]['target_id'] = $reward_id;
		entity_save('reward', $raffle_entry);
		drupal_set_message(t($raffleOnsMsg),'status');
		_play_library_program_send_pm_message($account_uid, $raffle_pm_sub, $raffle_pm_body);
	}
}




/**
 * Reward Onscreen Message
 */
function messages_for_reward_claim($entity_id) {

  $query = db_select('field_data_field_onscreen_prize','ons')
  ->fields('ons', array('field_onscreen_prize_value'))
  ->condition('entity_id',$entity_id)
  ->execute()
  ->fetchAssoc();

  return $query['field_onscreen_prize_value'];
}

/**
 * Raffle pivate message subject.
 */
function pm_raffle_messages_sub_for_reward_claim($entity_id) {

  $query = db_select('field_data_field_mes_subject_reward','rfsub')
  ->fields('rfsub', array('field_mes_subject_reward_value'))
  ->condition('entity_id',$entity_id)
  ->execute()
  ->fetchAssoc();

  return $query['field_mes_subject_reward_value'];
}

/**
 * Raffle pivate message body.
 */
function pm_raffle_messages_body_for_reward_claim($entity_id) {

  $query = db_select('field_data_field_message_reward_winner','rfbody')
  ->fields('rfbody', array('field_message_reward_winner_value'))
  ->condition('entity_id',$entity_id)
  ->execute()
  ->fetchAssoc();

  return $query['field_message_reward_winner_value'];
}


/**
 * Reward pivate message subject.
 */
function pm_reward_messages_sub_for_reward_claim($entity_id) {

  $query = db_select('field_data_field_messa_subj_reward','rwsub')
  ->fields('rwsub', array('field_messa_subj_reward_value'))
  ->condition('entity_id',$entity_id)
  ->execute()
  ->fetchAssoc();

  return $query['field_messa_subj_reward_value'];
}

/**
 * Reward pivate message body.
 */
function pm_reward_messages_body_for_reward_claim($entity_id) {

  $query = db_select('field_data_field_message_prize_winner','rwbody')
  ->fields('rwbody', array('field_message_prize_winner_value'))
  ->condition('entity_id',$entity_id)
  ->execute()
  ->fetchAssoc();

  return $query['field_message_prize_winner_value'];
}



/**
 * Raffle Onscreen Message
 */
function messages_for_raffle_entry($entity_id) {

  $query = db_select('field_data_field_onscreen_reward','ons')
  ->fields('ons', array('field_onscreen_reward_value'))
  ->condition('entity_id',$entity_id)
  ->execute()
  ->fetchAssoc();

  return $query['field_onscreen_reward_value'];
}

/**
 * Condition for reward start date and end date;
 */
function pl_reward_time_limit($rew_sdate, $rew_edate) {

  $current_time = time();
  if($rew_sdate <= $current_time && $current_time <=  $rew_edate) {
    return TRUE;
  } else {
    return FALSE;
  }
}

/**
 * reward claim after passing through all validations
 */
function pl_check_reward_validation($reward_ids, $account_uid){

  return 'test';
}

/**
 * Implements hook_node_update().
 */
function play_library_program_node_update($node) {

  if ($node->status == NODE_PUBLISHED) {
    $current_node = node_load($node->nid);

    // check node type being updated
    if ($current_node->status !== $node->status) {
      if($node->type == 'review_book' || $node->type == 'review_activity' || $node->type == 'movie_review' || $node->type == 'music_review' || $node->type == 'video_game_review') {
        $hook = "node_update|node|{$node->type}|published";
        _play_library_program_invoke_activity_entry_hooks($node, 'node', $hook);
        $node->workbench_moderation['updating_live_revision'] = 1;
      } else {
        $hook = "node_update|node|{$node->type}|published";
        _play_library_program_invoke_activity_entry_hooks($node, 'node', $hook);
      }      
    }
  }
}

/**
 * Implements hook_webform_submission_insert().
 */
function play_library_program_webform_submission_insert($webform, $submission) {
  $hook = "webform_submit|{$webform->nid}";
  _play_library_program_invoke_activity_entry_hooks($submission, 'webform', $hook);
}

/**
 * Implements hook_theme().
 */
function play_library_program_theme($existing, $type, $theme, $path) {
  return array(
    'play_library_program_activities_block' => array(
      'variables' => array('pending' => NULL, 'completed' => NULL),
      'template' => 'play-library-program-activities-block',
    ),
  );
}

/**
**implements hook userpoints
**/

function play_library_program_userpoints($op, &$params = array()) {
	//check if patron can get reward after getting points for activity
	if ($op == 'points after') {
		//Call all reward calculations if reward category is not general
		if ($params['tid'] !=0 and $params['points'] >= 1 ) {
			$term = taxonomy_term_load($params['tid']);
      $user_points_category_name = $term->name;
      if(substr($user_points_category_name, 0, 2) == 'R_'){
        $claimed_points = 0;
		    //Get user current points
			  $user_points = userpoints_get_current_points($params['uid'],$params['tid']);
        //$user_pre_points = $user_points - $params['points'];
				$reward_id = explode('R_', $user_points_category_name);
  			$rewards = entity_load('reward', array($reward_id[1]));
  			$reward = reset($rewards);
  			//get language codes for reward
  			$lang = field_language('reward',$reward);
  			foreach ($lang as $key => $value) {
  				${$key} = $value; 
  			}
  			$reward_category = $reward->field_category[$field_category][0]['value'];
  			$repeatable = $reward->field_repeatable[$field_repeatable][0]['value'];
  			//get repeat count if reward is set as repeatable
  			if($repeatable == 1 ){
  				$max_repeat = $reward->field_maximum_num_reward[$field_maximum_num_reward][0]['value'];
  			} else{
  				$max_repeat = 1;
  			}
  			$reward_points = $reward->field_points[$field_points][0]['value'];
  			$receieved_rewards = pl_receieved_rewards($params['uid'], $reward_id[1]);
  			$claimed_points = 0;
  			//Claim rewards till user has enough points to get reward
  			while($user_points >= $reward_points) {
  				if($receieved_rewards < $max_repeat || empty($max_repeat)){
  					pl_reward_claim($reward_id[1], $params['uid'], $reward_category);
  					$receieved_rewards = $receieved_rewards + 1;
  				}
  				$user_points =  $user_points - $reward_points;
  				$claimed_points = $claimed_points + $reward_points;
  				// drupal_set_message('User Points:'. $user_points.'|| Claimed points: '. $claimed_points.' || Received Rewards: '.$receieved_rewards. ' || Max repeat:'. $max_repeat);
  			}
  			if (($reward_points - $user_points) > 0){
  				$_SESSION[$user_points_category_name] = $reward_points - $user_points;
  			}
  			//deduct claimed points
  			if($claimed_points > 0){
  				$userpoint_rew = array(
  				'uid' => $params['uid'],
  				'points' => 0-$claimed_points,
  				'tid' => $params['tid'],
  				'display' => 0,
  				'description' => t('Deduction for reward claim for reward id '). $reward_id[1]
  			);
  				userpoints_userpointsapi($userpoint_rew);
        }
			}
		}
	}
}





/**
 * Implements hook_action_info().
 */
function play_library_program_action_info() {
    return array(
        'play_library_program_assign_reward_action' => array(
            'label' => t('Assign reward to each user'),
            'type' => 'user',
            'configurable' => TRUE,
            'vbo_configurable' => TRUE,
            'triggers' => array('any'),
        ),
        'play_library_program_assign_userpoints_action' => array(
            'label' => t('Assign userpoints to each user'),
            'type' => 'user',
            'configurable' => TRUE,
            'vbo_configurable' => TRUE,
            'triggers' => array('any'),
        ),
    );
}

function play_library_program_assign_reward_action_form($context, $form_state) {
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'reward');
    $query->entityCondition('bundle', array('physical_reward', 'print_reward', 'reward', 'sticker'));
    $results = $query->execute();
    $rewards = entity_load('reward', array_keys($results['reward']));
    $rewards_options = array();
    foreach ($rewards as $reward) {
        $rewards_options[$reward->id] = t('@reward_title (@reward_type)', array('@reward_title' => $reward->title, '@reward_type' => $reward->type));
    }

    $form['reward'] = array(
        '#title' => t('Reward'),
        '#type' => 'select',
        '#options' => $rewards_options,
        '#description' => t('Which reward are we going to assign to users?'),
        '#default_value' => isset($context['author']) ? $context['author'] : '',
        '#required' => TRUE,
    );
    return $form;
}

function play_library_program_assign_reward_action_submit($form, $form_state) {
    return array('reward' => $form_state['values']['reward']);
}

/**
 * Assign reward action via bulk operation.
 */
function play_library_program_assign_reward_action($account, $context) {
    $reward_id = $context['reward'];
    $account_uid = $account->uid;
    play_library_program_create_reward_claim($reward_id, $account);
}

function play_library_program_assign_userpoints_action_form($context, $form_state) {
    $points = array();
    for ($i = 1; $i <= 10; $i++) {
        $points[$i] = $i;
    }
    $form['points'] = array(
        '#title' => t('Points'),
        '#type' => 'select',
        '#options' => $points,
        '#description' => t('How many points should the user receive?'),
        '#default_value' => isset($context['points']) ? $context['points'] : 1,
        '#required' => TRUE,
    );
    return $form;
}

function play_library_program_assign_userpoints_action_submit($form, $form_state) {
    return array('points' => $form_state['values']['points']);
}

/**
 * Assign reward action via bulk operation.
 */
function play_library_program_assign_userpoints_action($account, $context) {
  $userpoints_txn = array(
    'uid' => $account->uid,
    'points' => $context['points'],
  );
  userpoints_userpointsapi($userpoints_txn);
}

/**
 * Creates an activity entry for non-actioned items.
 */
function play_library_program_complete_activity($activity_id, $type = 'nojs') {

  global $user;
  $activity_entry = play_library_program_create_activity_entry($activity_id, $user->uid);
  if ($type == 'nojs') {
    drupal_goto('');
  }
}

/**
 * Creates a new raffle winner.
 */
function play_library_program_create_raffle_winner($raffle_id, $uid) {
    global $user;
    $raffles = entity_load('raffle', array($raffle_id));
    $raffle = reset($raffles);
    $title = t("@raffle winner on @time", array('@raffle' => $raffle->title, '@time' => date('Y-m-d H:i')));
    $raffle_winner = entity_create('raffle', array('type' => 'raffle_winner', 'title' => $title, 'uid' => $uid));
    $raffle_winner->field_raffle_winner_raffle[LANGUAGE_NONE][0]['target_id'] = $raffle->id;
    $raffle_winner->field_raffle_winner[LANGUAGE_NONE][0]['target_id'] = $uid;
    entity_save('raffle', $raffle_winner);
    //drupal_goto('raffle/raffle/' . $raffle_id);
}

/**
 * Retrieves how many times an activity has been performed.
 */
function play_library_program_retrieve_activity_participation($activity_id, $account_id) {

  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'activity');
  $query->entityCondition('bundle', 'activity_entry');
  $query->propertyCondition('uid', $account_id);
  $query->fieldCondition('field_activity_entry_activity', 'target_id', $activity_id);
  return $query->count()->execute();
}

/**
 * Creates a new activity entry
 */
function play_library_program_create_activity_entry($activity_id, $account_id, $event_time = NULL, $sticker_tid) {
	if ($event_time <= time()){
		//Load required activity to be recorded
		$activities = entity_load('activity', array($activity_id));
		$activity = reset($activities);
		//get language codes for activity fields
		$lang = field_language('activity',$activity);
		foreach ($lang as $key => $value) {
	  		${$key} = $value;
	  	}
	  	if ($event_time == NULL){
	  		$event_time = time();
	  	}

		// Count for number of times activity has been performed.
		$count_activity_entry = play_library_program_retrieve_activity_participation($activity_id, $account_id);

	  	// Activity limit
	  	$no_of_time_user_perform_activity = $activity->field_activity_limit[$field_activity_limit][0]['value'];
	  	//Set $no_of_time_user_perform_activity to 0 if empty
	  	if (empty($no_of_time_user_perform_activity)){
	  		$no_of_time_user_perform_activity = 0;
	  	}
	  	// Activity points
	  	$activity_point = $activity->field_activity_points[$field_activity_points][0]['value'];

		// checking of activity frequency limit
		$activity_frequency_limit = play_library_program_frequency_limit($activity, $event_time, $account_id);

		// checking time range for activity to be performed
		$activity_time_limit = play_library_program_activity_time_limit($activity, $event_time);

		//Record activity only if user has not hit the maximumnumber of times he can perform the activity

		if($count_activity_entry < $no_of_time_user_perform_activity || $no_of_time_user_perform_activity == 0) {
			//Check frequency limits and time limits for activity 
	  		if (($activity_frequency_limit == TRUE) && ($activity_time_limit == TRUE)) {
	  			// title for activity entry in activity_entry bundle
	    		$title = t("@activity on @time", array('@activity' => $activity->title, '@time' => date("Y-m-d H:i", $event_time)));
	    		//if event time is set create activity for set event time 
	    		if ($event_time){
	    			$activity_entry = entity_create('activity', array('type' => 'activity_entry', 'title' => $title, 'uid' => $account_id, 'created' => $event_time, 'activity_points' => $activity_point));
	    		}

				//get language code for newly created activity
				$lang = field_language('activity',  $activity_entry);
				foreach ($lang as $key => $value) {
					${$key} = $value;
	  		}

  			//Get all field values of activity entry to be updated
  			$activity_entry->field_activity_entry_activity[$field_activity_entry_activity][0]['target_id'] = $activity->id;
   			$activity_entry->field_activity_point[$field_activity_point][0]['value'] = $activity_point;
    		$activity_entry->field_calendar_sticker_id[$field_calendar_sticker_id][0]['tid'] = $sticker_tid;
    		//Save activity entry

        $wrapper = entity_metadata_wrapper('activity', $activity_entry);
        $wrapper->save();
        $activity_entry_id = $wrapper->value();
    		//Return created activity entry id
    		$author = variable_get('pm_author');
    		$author_name = user_load_by_name($author);
    		$author_uid = $author_name->uid;
    		 
    		// Private message subject and body for every activity.
	 			$message_subject = $activity->field_activity_message_subject[$field_activity_message_subject][0]['value'];
				$message_body = $activity->field_activity_message[$field_activity_message][0]['value'];
	    	//Send Private message
	    	_play_library_program_send_pm_message($account_id, $message_subject, $message_body);
        return $activity_entry_id->id;
	  		}
	  	}else {
      
			drupal_set_message(t('Thanks for your submission. However you will not receive any points as you have exceeded maximum number of submissions allowed for this activity'), 'warning');
		  return FALSE;
    }
	} else {
		drupal_set_message(t('You can record an activity for today or past dates only'),'warning');
    return FALSE;
  } 
}

/**
 * Creates a new reward claim
 */
function play_library_program_create_reward_claim($reward_id, $account_id, $raffle_reward_claim = 0) {
    global $user;
    $uid = $user->uid;

  // query to check if reward is associates with raffle
  $que = db_select('eck_reward', 'eck_r');
  $que->join('field_data_field_reward_raffle', 're_ra', 'eck_r.id = re_ra.entity_id');
  $que->join('eck_raffle', 'eck_rf', 'eck_rf.id = re_ra.field_reward_raffle_target_id');
  $que->condition('eck_r.id', $reward_id);
  $que->condition('eck_rf.type', 'raffle');
  $que->fields('eck_rf', array('type'));
  $res = $que->execute();
  $is_raffle_reward = $res->rowCount();
  
  // raffle entry will only happen if the current reward_id is linked to a raffle and 
  // we are not claimimg raffle reward 
  if($is_raffle_reward && !$raffle_reward_claim) {
      $que = db_select('eck_reward', 'eck_r');
      $que->join('field_data_field_reward_raffle', 're_ra', 'eck_r.id = re_ra.entity_id');
      $que->join('eck_raffle', 'eck_rf', 'eck_rf.id = re_ra.field_reward_raffle_target_id');
      $que->condition('eck_r.id', $reward_id, '=');
      $que->fields('eck_rf', array('id'));
      $re = $que->execute()->fetchField();
 
      play_library_program_create_raffle_entry($re, $account_id);
    } else {
        $rewards = entity_load('reward', array($reward_id));
        $reward = reset($rewards);
        $title = t("@reward on @time", array('@reward' => $reward->title, '@time' => date('Y-m-d H:i')));
        $reward_claim = entity_create('reward', array('type' => 'reward_claim', 'title' => $title, 'uid' => $account_id));
        $reward_claim->field_reward_claim_id[LANGUAGE_NONE][0]['target_id'] = $reward->id;
          entity_save('reward', $reward_claim);
    }

    $rew_id = $reward_claim->id;

    $query = db_select('eck_reward','rew');
    $query->join('field_data_field_reward_claim_id','claim_id','claim_id.entity_id = rew.id');
    $query->fields('rew',array('title','id','uid','type'));
    $query->fields('claim_id',array('field_reward_claim_id_target_id'));
    $query->condition('type','reward_claim');
    $query->condition('uid',$account_id,'=');
    $query->condition('id',$rew_id,'=');
    $result = $query->execute()
    ->fetchAll();

    foreach($result as $reward_msg){
      $res_title = $reward_msg->title;
      $res_id = $reward_msg->id;
      $res_uid = $reward_msg->uid;
      $res_type = $reward_msg->type;
      $res_entity_id = $reward_msg->field_reward_claim_id_target_id;

      $sub_query_msg = db_select('field_data_field_reward_message','msg');
      $sub_query_msg->join('field_data_field_reward_notification','noti','noti.entity_id = msg.entity_id');
      $sub_query_msg->fields('msg',array('field_reward_message_value'));
      $sub_query_msg->fields('noti',array('field_reward_notification_value'));
      $sub_query_msg->condition('msg.entity_id',$res_entity_id);
      $sub_query = $sub_query_msg->execute()->fetchAll();

      foreach($sub_query as $onscreen_msg){
        $msg_notifications = $onscreen_msg->field_reward_message_value;
        $mail_notifications = $onscreen_msg->field_reward_notification_value;
      }

      db_insert('reward_notification_patron')
       ->fields(array(
        'reward_name' => $res_title,
        'reward_id' => $res_id,
        'uid' => $res_uid,
        'type' => $res_type,
        'reward_notifications' => $msg_notifications,
        'reward_mail_notifications' => $mail_notifications,
        ))
       ->execute();
    }
}



function _play_library_program_get_webforms() {
    $query = db_select('webform', 'w');
    $query->join('node', 'n', 'w.nid = n.nid');
    $query->fields('n');
    return $query->execute()->fetchAllAssoc('nid');
}

/**
 * Performs general firing hook check to create new activity entries
 */
function _play_library_program_invoke_activity_entry_hooks($entity, $type, $invoked_hook = '', $update_points = 0) {

  $entity_nid = $entity->nid;

  $query = db_select('node_revision','nr')
  ->fields('nr',array('vid'))
  ->condition('nid',$entity_nid)
  ->execute();

  $num_of_nodes = $query->rowCount();

  $hook = $invoked_hook;
  if (empty($hook)) {
    $hook = "entity_insert|{$type}|{$entity->type}";
  }

  if($num_of_nodes <= 2){
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'activity');
    $query->entityCondition('bundle', 'activity');
    $query->fieldCondition('field_activity_fired_hook', 'value', $hook);
    $result = $query->execute();

    foreach ($result as $entity_key => $entity_values) {
      if ($entity_key == 'activity') {
        foreach ($entity_values as $activity_entity) {
          $account = user_load($entity->uid);
          if(!$update_points) {
            play_library_program_create_activity_entry($activity_entity->id, $account->uid);
          } else {
            global $user;
            global $event_time;
            play_library_program_create_activity_entry($activity_entity->id, $user->uid, $event_time);
          }
        }
      }
    }
  }
}

/**
 * Function to return activity frequency
 */
function _get_activity_frequency($aid) {
  $query = db_select('field_data_field_activity_limit', 'fal');
  $query->fields('fal', array('field_activity_limit_value'));
  $query->condition('entity_id', $aid);
  $results = $query->execute();
  foreach ($results as $result) {
    return $result->field_activity_limit_value;
  }
}

//Returns tid for a term name
function _get_term_from_name($term_name, $vocabulary_name) {

  $term = taxonomy_get_term_by_name($term_name, $vocabulary_name);
  if(empty($term)) {
    // $activity_id = filter_var($term_name, FILTER_SANITIZE_NUMBER_INT);
    //$entity = entity_load('activity',$activity_id);
    pl_add_taxonomy_term($term_name, $vocabulary_name);
    $term = taxonomy_get_term_by_name($term_name, $vocabulary_name);
    // print_r("bsdasda");
  }
  // print_r(reset(reset($term)));die();
  return reset(reset($term));
}

function pl_userpoints_per_reward($tax_reward, $account_id, $points_for_reward){

  $userpoint_rew = array(
    'uid' => $account_id,
    'points' => $points_for_reward,
    'tid' => $tax_reward,
  );
return userpoints_userpointsapi($userpoint_rew);
}


/**
 * Processes a reward claim.
 */
function _play_library_program_process_activity_entry($entity, $type) {

	//Get language codes
	$lang = field_language('activity', $entity);
	foreach ($lang as $key => $value) {
		${$key} = $value;
	}
  // get the activity id and other details form $entity (activity entry).
  $activity_id = $entity->field_activity_entry_activity[$field_activity_entry_activity][0]['target_id'];
  $points_from_activity = $entity->field_activity_point[$field_activity_point][0]['value'];
  $activity_frequency = _get_activity_frequency($activity_id);
    
  // get the number of times user has performed the current activity
  $current_participation_count = play_library_program_retrieve_activity_participation($activity_id, $entity->uid);
    
  // call userpoint API to update user points
  if ($points_from_activity > 0 && $current_participation_count <= $activity_frequency) {
        $userpoints_txn = array(
        'uid' => $entity->uid,
        'points' => $points_from_activity,
        'display' => 0,
      );

      //Update user general points 
      userpoints_userpointsapi($userpoints_txn);


      // Update points for activity category
      $term = _get_term_from_name('A_'.$activity_id, 'userpoints');
      $user_act_points_txn = array(
        'uid' => $entity->uid,
        'points' => $points_from_activity,
        'tid' => $term,
        'display' => 0,
      );
      userpoints_userpointsapi($user_act_points_txn);   
      //Add points for reward category
      _play_library_program_add_points_to_rewards($activity_id, $points_from_activity, $entity->uid);
  }
}



// /**
//  * Function to update activity entry claimed points.
//  *
//  * @param
//  *   $entity_id Number ID of the row to update
//  *   $claimed_points Number New claimed points
//  */
// function update_activity_entry_claimed_points($entity_id, $claimed_points) {
//   db_update('field_data_field_claimed_point')
//   ->fields(array('field_claimed_point_value' => $claimed_points))
//   ->condition ('entity_id', $entity_id)
//   ->execute();
// }

/**
 * Function to return all activities to associated to given rewards.
 *
 * @param Array $rewards_id_ary
 *   array of reward ID's
 *
 * @return Array $activities
 *  array of activity ID's linked with given rewards
 */
function get_eligible_activities($rewards_id_ary) {
  $activities = array();
  if(count($rewards_id_ary)) {
    $query = db_select('field_data_field_reward_criteria_activity', 'frca');
    $query->join('field_data_field_reward_criteria_reward', 'frcr', 'frca.entity_id = frcr.entity_id');
    $query->condition('frcr.field_reward_criteria_reward_target_id', $rewards_id_ary, 'IN');
    $query->fields('frca', array('field_reward_criteria_activity_target_id'));
    $result = $query->execute()->fetchAll();
    foreach ($result as $value) {
      $activities[] = $value->field_reward_criteria_activity_target_id;
    }
  }
  return $activities;
}

/**
 * Function to return activity entries for given set of activities
 *
 * @param Number $account_id
 *   user ID whose activity entries to be returned
 *
 * @param Array $eligible_activities
 *   array of activities for which activity entry is to be selected
 *
 * @return mysql resultset $res
 *   query resultset
 */
function get_activity_entries_for_eligible_activities($account_id, $eligible_activities) {
  // Query to fetch all activity entries related to set of activities that are
  // linked to the reward user can earn, based on current activity
  $que = db_select('eck_activity', 'eck_a');
  $que->join('field_data_field_activity_entry_activity', 'fdfae', 'fdfae.entity_id = eck_a.id');
  $que->join('field_data_field_claimed_point', 'fdcp', 'fdcp.entity_id = eck_a.id');
  $que->join('field_data_field_activity_point', 'fdfap', 'fdfap.entity_id = eck_a.id');
  $que->condition('eck_a.uid', $account_id);
  $que->condition('fdfae.field_activity_entry_activity_target_id', $eligible_activities, 'IN');
  $que->condition('fdcp.field_claimed_point_value', 'fdfap.field_activity_point_value', '<=');
  $que->fields('fdcp', array('field_claimed_point_value'));
  $que->fields('fdfap', array('field_activity_point_value'));
  $que->fields('fdfae', array('entity_id'));
  $res = $que->execute();
  return $res;
}



function chk_reward_expiry($criteria_start_date, $criteria_end_date) {
    $current_date = time();
    $start_date = strtotime($criteria_start_date);
    $end_date = strtotime($criteria_end_date);  
    if($current_date >= $start_date && $current_date <= $end_date) {
      return FALSE;
    } else {
      return TRUE;
    }
}


//Function to validate user age group
function chk_user_age_for_reward($user_age, $start_age, $end_age) {
	//If only start age is set reward can be given to all users higher than this age
	if (empty($start_age) && empty($end_age)){
		return TRUE;	
	}
	//If only start age is set 
	elseif (empty($start_age) && !empty($end_age) && $user_age <= $end_age){
		return TRUE;	
	}
	//If only end age is set 
	elseif (empty($end_age) && !empty($start_age) && $start_age <= $user_age){
		return TRUE;	
	}
	//If bott start and end ages are set
	elseif($user_age >= $start_age && $user_age <= $end_age) {
		return TRUE;
	} else {
		return FALSE;
	}
}

/**play_library_program_create_reward_claim
 * Function to add reward claimed by user after an activity for calendar state
 */
function play_library_program_update_user_calendar_state($rid) {
    $cal_id = $_SESSION['usr_calendar_id'];
    unset($_SESSION['usr_calendar_id']);
    db_update('calendar')
        ->fields(array('reward_id' => $rid))
        ->condition ('id', $cal_id)
        ->execute();
}


/**
 * Retrieves satisfied reward criteria based on global points.
 */
function _play_library_program_get_global_reward_ids($user_pre_points, $user_points, $account_uid) {
    global $user;
    if (empty($account_uid)) {
        $account = $user;
    }
    else {
        $account = user_load($account_uid);
    }

    // Create exclusion list of rewards which are tied to activities.
    $exclude_ids = array(-1);
    $date = "" . date('Y-m-d') . " 00:00:00";
    $query = db_select('field_data_field_reward_criteria_activity', 'fdfrca');
    $query->fields('fdfrca', array('entity_id'));
    $results = $query->execute();
    foreach ($results as $result) {
        $exclude_ids[] = $result->entity_id;
    }

    $rids = array();
    // Get the non-repeated rewards first.
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'reward');
    $query->entityCondition('bundle', 'reward_criteria');
    $query->propertyCondition('id', $exclude_ids, 'NOT IN');
    $query->fieldCondition('field_reward_criteria_point_mark', 'value', $user_pre_points, '>');
    $query->fieldCondition('field_reward_criteria_point_mark', 'value', $user_points, '<=');
    $query->fieldCondition('field_reward_criteria_date_limit', 'value', $date, '<=');
    $query->fieldCondition('field_reward_criteria_date_limit', 'value2', $date, '>=');
    $query->fieldCondition('field_reward_criteria_repeatable', 'value', 0);
    $query->addTag('debug');
    $results = $query->execute();
    
    if (!empty($results['reward'])) {
        foreach($results['reward'] as $reward) {
            $reward_entities = entity_load('reward', array($reward->id));
            $reward_entity = reset($reward_entities);
            if (_play_library_program_reward_criteria_fulfilled($reward_entity, $account)) {
                foreach ($reward_entity->field_reward_criteria_reward[LANGUAGE_NONE] as $reward) {
                    $rids[] = $reward['target_id'];
                }
            }
        }
    }

    // Process the repeated ones next.
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'reward');
    $query->entityCondition('bundle', 'reward_criteria');
    $query->propertyCondition('id', $exclude_ids, 'NOT IN');
    $query->fieldCondition('field_reward_criteria_date_limit', 'value', $date, '<=');
    $query->fieldCondition('field_reward_criteria_date_limit', 'value2', $date, '>=');
    $query->fieldCondition('field_reward_criteria_repeatable', 'value', 1);
    $results = $query->execute();
    if (!empty($results['reward'])) {
        foreach($results['reward'] as $reward) {
            $reward_entities = entity_load('reward', array($reward->id));
            $reward_entity = reset($reward_entities);
            $modulus = $reward_entity->field_reward_criteria_point_mark[LANGUAGE_NONE][0]['value'];
            for ($i = $user_points; $i > $user_pre_points; $i--) {
                if ($i % $modulus == 0) {
                    if (_play_library_program_reward_criteria_fulfilled($reward_entity, $account)) {
                        foreach ($reward_entity->field_reward_criteria_reward[LANGUAGE_NONE] as $reward) {
                            $rids[] = $reward['target_id'];
                        }
                    }
                }
            }
        }
    }

    return array_unique($rids);
}


function _play_library_program_reward_criteria_fulfilled($reward_entity, $account_uid) {
	global $language;
	//Get language code for entity fields
	$lang = field_language('reward', $reward_entity);
	foreach ($lang as $key => $value) {
 		${$key} = $value;
	}

	//Get roles for reward in an array
	$rewardRoles = $reward_entity->field_roles_reward[$field_roles_reward];
	$arrSize = sizeof($rewardRoles);
	for ($i = 0; $i < $arrSize; $i++) {
		$rewRoles[] = $rewardRoles[$i]['value']; 
	}

	//Get roles of user in an array
	$user = user_load($account_uid);
	// Get user role from session if not available from user object
	if (sizeof($user->roles)==1){
		$userRoles =array_keys($_SESSION['program_user_role_id']);
		unset($_SESSION['program_user_role_id']);
	}
	else{
		$userRoles = array_keys($user->roles);
	}
	//Check if any array elements are identical
	$roles_arr = array_intersect($userRoles, $rewRoles);
	//set default to False
	$allowed = FALSE;
	//return true if user role is in reward user role list
	if (count($roles_arr)) {
		$allowed = TRUE;
	} else {
		$allowed = FALSE;
	}
	//Return
	return $allowed;
}


/**
 * Add points to reward category if user is eligible for the reward
 */

function _play_library_program_add_points_to_rewards($activity_ids, $points_to_add ,$account_uid) {
	// Condition if $account_uid is null.
	if (empty($account_uid)) {
    global $user;
    $account_uid = $user->uid;
    $role_ids = array_keys($user->roles);
  }
  else{
    $user = user_load($account_uid);
    $role_ids = array_keys($user->roles); 
  }
  // print_r($user->roles);
  //Get role ids from session if not available 
  if(sizeof($role_ids)<2){
    $role_ids = array_keys($_SESSION['program_user_role_id']);
    // print_r("session");
  }
  // print_r($role_ids);die();
  	
  if (!is_array($activity_ids)){
    $activity_ids = array($activity_ids);
  }
  
  
  // Array of reward ids associated with reward.
  
  //Get user DOB
  $dob_query = db_select('profile', 'pf');
  $dob_query->LEFTJOIN('field_data_field_user_birthday', 'fdfub', 'fdfub.entity_id = pf.pid');
  $dob_query->condition('pf.uid', $account_uid);
  $dob_query->fields('fdfub', array('field_user_birthday_value'));
  $res_dob = $dob_query->execute()->fetchAll();


  //Get user age if DOB is available
  if(!empty($res_dob)){
    //Get DOB
    $dob_timestamp = strtotime($res_dob[0]->field_user_birthday_value);   
  } else {
    //get DOB from session 
    $dob_timestamp = $_SESSION['user_birth_dt'];
    // unset($_SESSION['user_birth_dt']);
  }
  //Calculate user Age
  $current_time = time();
  $user_age = floor(($current_time - $dob_timestamp) / (60*60*24*365));

  // get reward field values for all associated rewards
  // if (isset($dob_timestamp)){ 
    $que = db_select('eck_reward', 'eck_r');
    $que->leftjoin('field_data_field_points', 'fdfp', 'eck_r.id = fdfp.entity_id');
    $que->leftjoin('field_data_field_activities_reward', 'fdfar', 'eck_r.id = fdfar.entity_id');
    $que->leftjoin('field_data_field_roles_reward', 'fdfrr', 'eck_r.id = fdfrr.entity_id');
    $que->leftjoin('field_data_field_status_reward', 'fdfsr', 'eck_r.id = fdfsr.entity_id');
    $que->leftjoin('field_data_field_repeatable', 'fdfr', 'eck_r.id = fdfr.entity_id');
    $que->leftjoin('field_data_field_age_group', 'fdfag', 'eck_r.id = fdfag.entity_id');
    $que->leftjoin('field_data_field_maximum_num_reward', 'fdfmnr', 'eck_r.id = fdfmnr.entity_id');
    $que->leftjoin('field_data_field_dates_reward', 'fdfdr', 'eck_r.id = fdfdr.entity_id');
    $que->condition('fdfar.field_activities_reward_target_id', $activity_ids, 'IN');
    // $que->condition(db_or()->condition('fdfag.field_age_group_from', $user_age, '<=')->isNull('fdfag.field_age_group_from'));
    // $que->condition(db_or()->condition('fdfag.field_age_group_to', $user_age, '>=')->isNull('fdfag.field_age_group_to'));
    $que->condition('fdfrr.field_roles_reward_value', $role_ids, 'IN');
    // $que->condition('fdfdr.field_dates_reward_value', time(), '<');
    // $que->condition('fdfdr.field_dates_reward_value2', time(), '>');
    $que->condition('fdfsr.field_status_reward_value', 'active');
    $que->fields('eck_r', array('id'));
    $que->fields('fdfp', array('field_points_value'));
    $que->fields('fdfr', array('field_repeatable_value'));
    $que->fields('fdfdr', array('field_dates_reward_value'));
    $que->fields('fdfdr', array('field_dates_reward_value2'));
    $que->fields('fdfmnr', array('field_maximum_num_reward_value'));
    $que->distinct('eck_r', array('id'));
    $res = $que->execute()->fetchAll();
    
    //Add points to all retrived rewards
    if(!empty($res)){
      foreach ($res as $key => $value) {
        if (strtotime($value->field_dates_reward_value)<= time() && strtotime($value->field_dates_reward_value2) >= time()){
          $repeatable = $value->field_repeatable_value;
          $max_repeat = $value->field_maximum_num_reward_value;
          $reward_id = $value->id;
          $rew_points = $value->field_points_value;
          $receieved_rewards = pl_receieved_rewards($account_uid, $reward_id);
          //get max repeat only if repeatable flag set
          if ($repeatable == 0){
            $max_repeat = 1;
          }
          if (!empty($max_repeat) || $max_repeat > 0){
            $max_points = ($max_repeat-$receieved_rewards) *  $rew_points;
          }else{
            $max_points = $points_to_add;
          }
          //Add only points that are required for the reward
          if($points_to_add < $max_points){
            $reward_points_to_add = $points_to_add;
          } else{
            $reward_points_to_add = $max_points;
          }      
          if($reward_points_to_add > 0 ){
            //Get reward term id
            $term = _get_term_from_name('R_'.$reward_id, 'userpoints');
            if(isset($term)){
              $userpoint_rew = array(
                'uid' => $account_uid,
                'points' => $reward_points_to_add,
                'tid' => $term,
                'display' => 0,
              );
              userpoints_userpointsapi($userpoint_rew);
            }
          }
        } // foreach ends here.
      } // if conditions for giving rewards ends here.
    }
  // }
}


/*
Fuction to send private message
*/
function _play_library_program_send_pm_message($account_id, $notification_subject, $notification, $author_uid = NULL){

  if (empty($account_id)) {
      global $user;
      $account_id = $user->uid;
  }

  //Get Author id set on config page if not set
  if($author_uid == NULL){
  	$author = variable_get('pm_author');
  	$author_name = user_load_by_name($author);
  	$author_uid = array('author'=>$author_name);
  } else{
  	$author_uid = array('author'=>user_load($author_uid));
  }

  //Verify if all parameters are set for private message
  if (!empty($notification_subject) || !empty($notification) || !empty($author_uid)){
    privatemsg_new_thread(array(user_load($account_id)), $notification_subject, $notification, $author_uid);
    return TRUE;
  }
  else{
    watchdog('play_library_program','$notification_subject or $notification or $author_uid is not defined',   
    NULL, 
    $severity = WATCHDOG_NOTICE, 
    $link = NULL);
    return FALSE;
  }
}

/*
/Function to update actiity entry
*/
function play_library_program_update_activity_entry($activity_entry_id, $update_time, $user_id, $activity_id){
	if ($user_id == Null){
		global $user;
		$user_id = $user->uid;
	}

	//Verify if new date is within activity date and frequency limit
	$activity = entity_load('activity', array($activity_id));
	$activity_frequency_limit = play_library_program_frequency_limit(reset($activity), $update_time, $user_id);
	$activity_time_limit = play_library_program_activity_time_limit(reset($activity), $update_time);

	//print_r('message ' .$activity_frequency_limit.'||'.$activity_time_limit);
	$activity_entry = entity_load('activity',array($activity_entry_id));
	if ($activity_frequency_limit == TRUE && $activity_time_limit == TRUE){
	    $w_activity = entity_metadata_wrapper('activity', reset($activity_entry));
	    $w_activity->created = $update_time;
	    $w_activity->save();
	    drupal_set_message(t('Your activity date is updated to <b>'. date('d-M-Y',$update_time)).'</b>', 'status');
	}
}



/*
Function to get next closest reward 
*/
function play_library_program_next_close_reward_points($activity_ids, $uid = NULL) {
	//Get cuurent logged in user if UID is NULL
	if ($uid == NULL){
		global $user;
		$uid = $user->uid;
    $role_ids = array_keys($user->roles);
	}

  if(!is_array($activity_ids)){
    $activity_ids = array($activity_ids);
  }

  //Get user Age
  $dob_query = db_select('profile', 'pf');
  $dob_query->LEFTJOIN('field_data_field_user_birthday', 'fdfub', 'fdfub.entity_id = pf.pid');
  $dob_query->condition('pf.uid', $uid);
  $dob_query->fields('fdfub', array('field_user_birthday_value'));
  $res_dob = $dob_query->execute()->fetchAll();

  //Get user age if DOB is available
  if(!empty($res_dob)){
    //Get DOB
    $dob_timestamp = strtotime($res_dob[0]->field_user_birthday_value); 
    //Calculate user Age
    $current_time = time();
    $user_age = floor(($current_time - $dob_timestamp) / (60*60*24*365));  
	}

	// get reward points for all associated rewards
	$que = db_select('eck_reward', 'eck_r');
	$que->leftjoin('field_data_field_points', 'fdfp', 'eck_r.id = fdfp.entity_id');
	$que->leftjoin('field_data_field_activities_reward', 'fdfar', 'eck_r.id = fdfar.entity_id');
  $que->leftjoin('field_data_field_roles_reward', 'fdfrr', 'eck_r.id = fdfrr.entity_id');
	$que->leftjoin('field_data_field_status_reward', 'fdfsr', 'eck_r.id = fdfsr.entity_id');
	$que->leftjoin('field_data_field_repeatable', 'fdfr', 'eck_r.id = fdfr.entity_id');
	$que->leftjoin('field_data_field_age_group', 'fdfag', 'eck_r.id = fdfag.entity_id');
  $que->leftjoin('field_data_field_maximum_num_reward', 'fdfmnr', 'eck_r.id = fdfmnr.entity_id');
	$que->condition('fdfar.field_activities_reward_target_id', $activity_ids, 'IN');
  //Verify age group only if DOB is available
  if(!empty($res_dob)){
    $que->condition(db_or()->condition('fdfag.field_age_group_from', $user_age, '<=')->isNull('fdfag.field_age_group_from'));
    $que->condition(db_or()->condition('fdfag.field_age_group_to', $user_age, '>=')->isNull('fdfag.field_age_group_to'));
	}
  $que->condition('fdfrr.field_roles_reward_value', $role_ids, 'IN');
	$que->condition('fdfsr.field_status_reward_value', 'active');
	$que->fields('eck_r', array('id'));
	$que->fields('fdfp', array('field_points_value'));
	$que->fields('fdfr', array('field_repeatable_value'));
	$que->fields('fdfmnr', array('field_maximum_num_reward_value'));
	$res = $que->execute()->fetchAll();
  
	//Validate conditions
	foreach ($res as $key=>$value) {
		//Get current points of user
		$receieved_rewards = pl_receieved_rewards($uid, $value->id);
		$rew_tid = _get_term_from_name('R_'.$value->id, 'userpoints');
		$user_points = userpoints_get_current_points($uid, $rew_tid);
    $req_points = ($value->field_points_value) - $user_points;
    
		if ($value->field_repeatable_value == 1){
			if(!empty($value->field_maximum_num_reward_value)){
				if ($receieved_rewards < $value->field_maximum_num_reward_value){
					if ($req_points > 0){
            $points_needed[] = $req_points;
					}
				}
			}else{
				if ($req_points > 0){
          $points_needed[] = $req_points;
				}
			}
		} else{
			if($receieved_rewards <= 0){
				if ($req_points > 0){
          $points_needed[] = $req_points;
				}
			}else{
        $prev_point[] = $req_points;
      }
		}
	}//end of for each
  
  if(!empty($points_needed)){
    $next_rew_points = min($points_needed);
  }
  else{
   $next_rew_points=0; 
  }
	return $next_rew_points;
}



/*
/Function to get totalpoints based on firing hook
*/
function play_library_program_get_activity_points(){
  global $user;
  $uid = $user->uid;
  $query = db_select('eck_activity','act');
  $query->join('field_data_field_activity_fired_hook','hook', 'hook.entity_id = act.id');
  $query->fields('act', array('id'));
  $query->fields('hook',array('field_activity_fired_hook_value'));
  $result = $query->execute()->fetchAll();
  //Get activity IDs for every firing hook
  foreach ($result as $value) {
    $act_tid = _get_term_from_name('A_'.$value->id, 'userpoints');
    switch ($value->field_activity_fired_hook_value) {
      case 'node_update|node|review_book|published':
        $points['book review'] = $points['book review'] + userpoints_get_current_points($uid, $act_tid);
        break;
      case 'node_update|node|review_activity|published':
        $points['activity review'] = $points['activity review'] + userpoints_get_current_points($uid, $act_tid);
        break;
      case 'node_update|node|music_review|published':
        $points['music review'] = $points['music review'] + userpoints_get_current_points($uid, $act_tid);
        break;
      case 'node_update|node|movie_review|published':
        $points['movie review'] = $points['movie review'] + userpoints_get_current_points($uid, $act_tid);
        break;
      case 'node_update|node|video_game_review|published':
        $points['video game review'] = $points['video game review'] + userpoints_get_current_points($uid, $act_tid);
        break;
      case 'node_update|node|booklist|published':
        $points['booklist'] = $points['booklist'] + userpoints_get_current_points($uid, $act_tid);
        break;
      case 'progress_page':
        $points['activity'] = $points['activity'] + userpoints_get_current_points($uid, $act_tid);
        break;
      default:
        break;
    }
  }
  //Get general Points
  $points['general'] = $points['general'] + userpoints_get_current_points($uid,0);
  //Add all review points
  $points['review'] =  $points['book review'] + $points['activity review'] + $points['music review'] +$points['movie review'] + $points['video game review'];
  
  return $points;
}

/*
/Function to get user raffle ticket count
*/
function _play_library_program_get_raffle_ticket_count(){
  global $user;
  $user_id = $user->uid;
  $que = db_select('eck_reward', 'rew');
  $que-> CONDITION('rew.type', 'raffle_claim');
  $que-> CONDITION('rew.uid', $user_id);
  $que->FIELDS('rew', array('id'));
  $result = $que->execute()->fetchAll();
  $reward_count=count($result);
  return $reward_count;
}